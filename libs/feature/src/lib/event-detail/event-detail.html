<div class="py-8">

  <!-- Botón de regreso -->
  <button
  (click)="goBack()"
  class="mb-6 inline-flex items-center px-4 py-2  text-white font-semibold rounded-lg transition-colors">
  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
  </svg>
  Back to Events
</button>
  @if (windowDetails(); as session) {
    <!-- Header de la ventana -->
    <div class="rounded-2xl bg-secondary shadow-lg my-4 mx-2 p-6 text-white">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-extrabold text-accent">
            {{ session.eventDisplayId }} · {{ session.region }}
          </h1>
          <p class="text-sm opacity-90">
            Window: <span class="font-mono">{{ session.windowId }}</span>
          </p>
          <p class="text-sm opacity-90">
            {{ session.beginTime | date:"d MMMM y, HH:mm" }} - {{ session.endTime | date:"d MMMM y, HH:mm" }}
          </p>
        </div>

        <div class="flex flex-wrap gap-3 items-center justify-start md:justify-end">
          <span class="px-3 py-1 rounded-full text-xs font-semibold bg-black/20">
            Match cap: {{ session.matchCap }}
          </span>
          <span class="px-3 py-1 rounded-full text-xs font-semibold bg-black/20">
            {{ session.useIndividualScores ? 'Individual scores' : 'Team scores' }}
          </span>
          <span class="px-3 py-1 rounded-full text-xs font-semibold"
                [class.bg-green-600]="session.finished"
                [class.bg-yellow-600]="!session.finished">
            {{ session.finished ? 'Finished' : 'Ready / In progress' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="rounded-2xl bg-secondary shadow-lg my-4 mx-2 p-6 text-white">
      <h2 class="text-xl font-bold mb-4">Leaderboard</h2>

      @if (sortedResults().length) {
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left opacity-80 border-b border-white/10">
                <th class="py-2 pr-4">Rank</th>
                <th class="py-2 pr-4">Team</th>
                <th class="py-2 pr-4">Points</th>
                <th class="py-2 pr-4">Score</th>
                <th class="py-2 pr-4">Percentile</th>
                <th class="py-2 pr-0">Breakdown</th>
              </tr>
            </thead>
            <tbody>
              @for (row of sortedResults(); track row.rank) {
                <tr class="border-b border-white/5 align-top">
                  <td class="py-3 pr-4 font-mono font-semibold">#{{ row.rank }}</td>

                  <td class="py-3 pr-4">
                    <div class="flex flex-col gap-1">
                      @for (player of row.team; track player.id) {
                        <div class="flex items-center gap-2">
                          <lib-flags [country]="player?.flag || ''"></lib-flags>
                          <span class="truncate">{{ player.name }}</span>
                        </div>
                      }
                    </div>
                  </td>

                  <td class="py-3 pr-4 font-semibold">{{ row.pointsEarned }}</td>
                  <td class="py-3 pr-4">{{ row.score }}</td>
                  <td class="py-3 pr-4">{{ row.percentile | number:'1.0-2' }}</td>

                  <td class="py-3 pr-0">
                    <button class="px-3 py-1 rounded-lg bg-black/20 hover:bg-black/30 text-xs font-semibold"
                            (click)="toggleRank(row.rank)">
                      {{ expandedRank() === row.rank ? 'Hide' : 'Show' }}
                    </button>

                    @if (expandedRank() === row.rank) {
                      <div class="mt-3 rounded-xl bg-black/20 p-3">
                        <div class="text-xs font-semibold opacity-80 mb-2">Point breakdown</div>
                        @if (breakdownEntries(row.pointBreakdown).length) {
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            @for (b of breakdownEntries(row.pointBreakdown); track b.key) {
                              <div class="flex items-center justify-between gap-3 text-xs">
                                <span class="font-mono opacity-90">{{ b.key }}</span>
                                <span class="opacity-80">x{{ b.timesAchieved }}</span>
                                <span class="font-semibold">{{ b.pointsEarned }}</span>
                              </div>
                            }
                          </div>
                        } @else {
                          <div class="text-xs opacity-70">No breakdown available.</div>
                        }
                      </div>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      } @else {
        <p class="text-sm opacity-80">No results available.</p>
      }
    </div>

    <!-- Payout -->
    @if (payoutRanks().length) {
      <div class="rounded-2xl bg-secondary shadow-lg my-4 mx-2 p-6 text-white">
        <h2 class="text-xl font-bold mb-4">Payout</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left opacity-80 border-b border-white/10">
                <th class="py-2 pr-4">Placement threshold</th>
                <th class="py-2 pr-0">Rewards</th>
              </tr>
            </thead>
            <tbody>
              @for (rank of payoutRanks(); track rank.threshold) {
                <tr class="border-b border-white/5 align-top">
                  <td class="py-3 pr-4 font-semibold">Top {{ rank.threshold }}</td>
                  <td class="py-3 pr-0">
                    <div class="flex flex-col gap-1">
                      @for (p of rank.payouts; track p.rewardType + '-' + p.value + '-' + p.quantity) {
                        <div class="text-xs">
                          <span class="font-semibold">{{ p.rewardType }}</span>
                          <span class="opacity-80">· {{ p.value }} (x{{ p.quantity }})</span>
                        </div>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

    <!-- Scoring rules -->
    @if (scoringRules().length) {
      <div class="rounded-2xl bg-secondary shadow-lg my-4 mx-2 p-6 text-white">
        <h2 class="text-xl font-bold mb-4">Scoring rules</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left opacity-80 border-b border-white/10">
                <th class="py-2 pr-4">Tracked stat</th>
                <th class="py-2 pr-4">Rule</th>
                <th class="py-2 pr-0">Tiers</th>
              </tr>
            </thead>
            <tbody>
              @for (rule of scoringRules(); track rule.trackedStat) {
                <tr class="border-b border-white/5 align-top">
                  <td class="py-3 pr-4 font-mono">{{ rule.trackedStat }}</td>
                  <td class="py-3 pr-4">{{ rule.matchRule }}</td>
                  <td class="py-3 pr-0">
                    <div class="flex flex-col gap-1">
                      @for (tier of rule.rewardTiers; track tier.keyValue + '-' + tier.pointsEarned) {
                        <div class="text-xs">
                          <span class="font-semibold">{{ tier.pointsEarned }} pts</span>
                          <span class="opacity-80">
                            @if (tier.multiplicative) { · multiplicative }
                            · key {{ tier.keyValue }}
                          </span>
                        </div>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
  } @else {
    <div class="rounded-2xl bg-secondary shadow-lg my-4 mx-2 p-6 text-white">
      <p class="text-sm opacity-80">Cargando detalles de la ventana…</p>
    </div>
  }

</div>
